<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Report Generator</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .form-container {
            padding: 40px;
        }
        
        .section {
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .section:last-child {
            border-bottom: none;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        
        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin-right: 12px;
            border-radius: 2px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: #555;
            font-size: 14px;
        }
        
        .field-hint {
            display: block;
            margin-top: 6px;
            font-size: 12px;
            color: #888;
        }
        
        .field-hint code {
            font-family: monospace;
            background: #eee;
            padding: 1px 4px;
            border-radius: 3px;
        }
        
        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        
        select {
            cursor: pointer;
            background: white;
            appearance: auto;
        }
        
        select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .list-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: flex-start;
        }
        
        .list-item input {
            flex: 1;
        }
        
        .btn-remove {
            background: #ff4757;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
            white-space: nowrap;
        }
        
        .btn-remove:hover {
            background: #ff3838;
        }
        
        .btn-add {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.3s;
            margin-top: 10px;
        }
        
        .btn-add:hover {
            background: #5568d3;
        }
        
        .execution-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
        }
        
        .execution-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            gap: 8px;
        }
        
        .execution-item-title {
            font-weight: 700;
            color: #333;
        }
        
        .friction-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
            position: relative;
        }
        
        .sop-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
        }
        
        .sop-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .sop-item-title {
            font-weight: 700;
            color: #333;
        }
        
        .friction-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .friction-item-title {
            font-weight: 700;
            color: #333;
        }
        
        .focus-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
        }
        
        .focus-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .focus-item-title {
            font-weight: 700;
            color: #333;
        }
        
        .ai-task {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
        }
        
        .ai-task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .ai-task-title {
            font-weight: 700;
            color: #333;
        }
        
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .submit-section {
            text-align: center;
            padding-top: 30px;
            margin-top: 30px;
            border-top: 2px solid #f0f0f0;
        }
        
        .btn-submit {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 40px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }
        
        .btn-submit:active {
            transform: translateY(0);
        }
        
        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
        }
        
        .error {
            display: none;
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #c62828;
        }
        
        .success {
            display: none;
            background: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2e7d32;
        }

        .draft-banner {
            display: none;
            background: #fff8e1;
            color: #6d4c41;
            padding: 12px 14px;
            border-radius: 8px;
            margin-bottom: 16px;
            border-left: 4px solid #ffb300;
        }

        .draft-banner-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: wrap;
        }

        .draft-banner-text {
            font-size: 13px;
            font-weight: 600;
        }

        .draft-banner-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-secondary {
            background: #ffffff;
            color: #6d4c41;
            border: 1px solid rgba(109, 76, 65, 0.35);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
        }

        .btn-secondary:hover {
            background: rgba(109, 76, 65, 0.06);
        }
        
        .week-picker-row {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .week-picker-row input#week-calendar {
            flex: 1;
            min-width: 180px;
            cursor: pointer;
            background: white;
        }
        
        .week-range-label {
            font-size: 14px;
            color: #555;
            font-weight: 500;
        }
        
        .flatpickr-calendar.open {
            z-index: 9999;
        }
        
        .ai-assist-section {
            background: #f0f4ff;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }
        
        .ai-assist-section summary {
            cursor: pointer;
            font-weight: 600;
            color: #333;
        }
        
        .ai-assist-notes {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            font-size: 14px;
            font-family: inherit;
            margin: 12px 0;
        }
        
        .ai-assist-notes:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn-suggest {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .btn-suggest:hover { background: #5568d3; }
        .btn-suggest:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .ai-suggest-result {
            margin-top: 12px;
            padding: 16px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .ai-suggest-result pre { font-size: 12px; margin: 0; white-space: pre-wrap; }
        
        .ai-preview-section {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .ai-preview-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .ai-preview-title {
            font-weight: 700;
            color: #667eea;
            font-size: 14px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .ai-preview-content {
            font-size: 13px;
            color: #333;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        .ai-preview-item {
            margin-bottom: 12px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #667eea;
        }
        
        .ai-preview-item-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
            font-size: 13px;
        }
        
        .ai-preview-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            align-items: center;
        }
        
        .ai-preview-toggle button {
            background: #f0f0f0;
            border: 1px solid #d0d0d0;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .ai-preview-toggle button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .ai-preview-toggle button:hover {
            background: #e0e0e0;
        }
        
        .ai-preview-toggle button.active:hover {
            background: #5568d3;
        }
        .ai-error { color: #c62828; margin-top: 8px; }
        .ai-apply-row { margin-top: 10px; }

        .ai-assist-hint {
            margin: 8px 0 4px;
            font-size: 13px;
            color: #444;
        }

        .ai-assist-example {
            margin: 10px 0 12px;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.75);
            border: 1px solid #d8defa;
            border-radius: 8px;
        }

        .ai-assist-example summary {
            font-weight: 600;
            color: #333;
        }

        .ai-assist-example pre {
            margin: 10px 0 8px;
            padding: 10px;
            background: #0b1020;
            color: #e6e9f5;
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.45;
            white-space: pre-wrap;
        }

        .ai-example-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
            
            .form-container {
                padding: 20px;
            }
            
            .week-picker-row {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Weekly Report Generator</h1>
            <p>Fill out the form below and generate your formatted Word document</p>
            <p style="font-size: 11px; opacity: 0.7; margin-top: 8px;">v{{ version }}</p>
        </div>
        
        <div class="form-container">
            <div class="error" id="error-message"></div>
            <div class="success" id="success-message"></div>
            <div class="loading" id="loading">Generating your report... Please wait.</div>

            <div class="draft-banner" id="draft-banner">
                <div class="draft-banner-row">
                    <div class="draft-banner-text" id="draft-banner-text"></div>
                    <div class="draft-banner-actions">
                        <button type="button" class="btn-secondary" id="draft-clear-btn">Clear saved draft</button>
                    </div>
                </div>
            </div>
            
            <details class="ai-assist-section">
                <summary>‚ú® AI Assist ‚Äì suggest from notes or improve text</summary>
                <p style="margin: 8px 0 4px; font-size: 13px; color: #555;">Paste ideas, or rough notes. AI will suggest content for the report fields.</p>
                <div class="form-group" style="margin-top: 12px;">
                    <label for="ai-style-select">Report Style:</label>
                    <select id="ai-style-select" style="max-width: 300px;">
                        <option value="quick">Quick Structure (concise bullets)</option>
                        <option value="detailed">Full Report (polished narrative)</option>
                    </select>
                    <small class="field-hint" style="margin-top: 4px; display: block;">
                        <strong>Quick Structure:</strong> Fast extraction, concise bullets.<br>
                        <strong>Full Report:</strong> Polished narrative with context‚Äîpublication-ready, like ChatGPT output.
                    </small>
                </div>
                <div class="ai-assist-hint">üí° <strong>Tip:</strong> Paste rough notes with simple headings (This week / Next week / Friction / AI Acceleration). Same notes work for both styles!</div>
                <div class="ai-assist-hint">üìù <strong>When to use Full Report:</strong> Management reviews, detailed updates. Use Quick Structure for fast internal reports.</div>
                <div class="ai-assist-hint">Note: blank fields show as <code>N/A</code> in the Word document. Bullets must start a new line with <code>-</code>.</div>
                <textarea id="ai-notes" class="ai-assist-notes" placeholder="This week:
- ...

AI Acceleration (optional):
- &lt;tool&gt;: &lt;what it helped with&gt; (~time saved)
  - Insight: ...

Friction (optional):
- ...
Action:
- ...
Ask:
- N/A

Next week:
- ..."></textarea>
                <details class="ai-assist-example">
                    <summary>Example notes template (copy/paste) ‚Äî works for both styles</summary>
                    <pre id="ai-example-text">This week:
- &lt;3-8 bullets: what you did / shipped&gt;
- Link(s): &lt;PR / Jira / Figma / Docs&gt; (optional)

AI Acceleration (optional):
- &lt;tool&gt;: &lt;what it helped with&gt; (~time saved)
  - Insight: &lt;what worked&gt;
  - Limitation: &lt;what still needed manual work / risk&gt;

Friction (optional):
- &lt;what was harder than expected / blocked you&gt;
Action:
- &lt;what you did to resolve/unblock&gt;
Ask:
- N/A

Next week:
- &lt;2-5 bullets: plans&gt;

Advanced (optional): if you want the AI to produce 2-5 Execution items, add headings like:
Execution &amp; Output:
- &lt;Theme 1&gt;: ...
- &lt;Theme 2&gt;: ...</pre>
                    <div class="ai-example-actions">
                        <button type="button" class="btn-suggest" id="ai-example-copy">Copy example</button>
                        <span id="ai-example-status" style="font-size: 13px; color: #666;"></span>
                    </div>
                </details>
                <div>
                    <button type="button" class="btn-suggest" id="ai-suggest-btn">Suggest for report</button>
                    <span id="ai-suggest-status" style="margin-left: 10px; font-size: 13px; color: #666;"></span>
                </div>
                <div id="ai-suggest-result-container" style="display: none;">
                    <div class="ai-preview-toggle">
                        <button type="button" id="ai-view-formatted" class="active">üìÑ Formatted</button>
                        <button type="button" id="ai-view-json">{ } JSON</button>
                    </div>
                    <div id="ai-suggest-result" class="ai-suggest-result"></div>
                </div>
                <div id="ai-suggest-error" class="ai-error" style="display: none;"></div>
                <div id="ai-apply-row" class="ai-apply-row" style="display: none;">
                    <button type="button" class="btn-suggest" id="ai-apply-btn">Apply to form</button>
                    <span id="ai-apply-status" style="margin-left: 10px; font-size: 13px; color: #666;"></span>
                </div>
            </details>
            
            <form id="report-form">
                <!-- Basic Information -->
                <div class="section">
                    <div class="section-title">Basic Information</div>
                    <div class="two-column">
                        <div class="form-group">
                            <label for="name">Name *</label>
                            <input type="text" id="name" name="name" value="{{ defaults.name }}" required>
                        </div>
                        <div class="form-group">
                            <label for="role">Role *</label>
                            <input type="text" id="role" name="role" value="{{ defaults.role }}" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="name_for_file">Name for filename</label>
                        <input type="text" id="name_for_file" name="name_for_file" value="{{ defaults.name_for_file }}" placeholder="e.g. [CAP Weekly Report] FirstName LastName">
                        <small class="field-hint">Enter your desired filename (without .docx). Example: "[CAP Weekly Report] FirstName LastName" or just "FirstName LastName". Leave blank to use your name above.</small>
                    </div>
                    <div class="form-group">
                        <label for="week-calendar">Week *</label>
                        <div class="week-picker-row">
                            <input type="text" id="week-calendar" readonly placeholder="Pick a date to select week" aria-label="Pick a date to select report week">
                            <span id="week-range-label" class="week-range-label"></span>
                        </div>
                        <input type="hidden" name="week" id="week-value" value="{{ defaults.week }}" required>
                    </div>
                </div>
                
                <!-- Weekly Objective -->
                <div class="section">
                    <div class="section-title">Weekly Objective</div>
                    <div class="form-group">
                        <label for="weekly_objective">Weekly Objective (One Sentence)</label>
                        <textarea id="weekly_objective" name="weekly_objective">{{ defaults.weekly_objective }}</textarea>
                    </div>
                </div>
                
                <!-- Execution & Output -->
                <div class="section">
                    <div class="section-title">Execution & Output</div>
                    <div id="execution-output-list">
                        {% for item in defaults.execution_output %}
                        <div class="execution-item">
                            <div class="execution-item-header">
                                <span class="execution-item-title">Execution {{ loop.index }}</span>
                                <button type="button" class="btn-remove" onclick="removeExecutionItem(this)">Remove</button>
                            </div>
                            <div class="form-group">
                                <label>Summary</label>
                                <input type="text" name="execution_summary[]" value="{{ item.summary }}" placeholder="Bold statement / one-line summary">
                            </div>
                            <div class="form-group">
                                <label>Content</label>
                                <textarea name="execution_content[]" placeholder="Type normally for text. Start a line with - for a bullet.&#10;Example:&#10;this is my work&#10;- bullet one&#10;- bullet two&#10;more text" rows="6">{{ item.content }}</textarea>
                                <small class="field-hint">Start a line with <code>-</code> for a bullet; other lines are normal text.</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="btn-add" onclick="addExecutionItem()">+ Add Item</button>
                </div>
                
                <!-- AI Acceleration Tasks -->
                <div class="section">
                    <div class="section-title">AI Acceleration Tasks</div>
                    <div id="ai-tasks-list">
                        {% for task in defaults.ai_tasks %}
                        <div class="ai-task" data-task-index="{{ loop.index0 }}">
                            <div class="ai-task-header">
                                <div class="ai-task-title">Task {{ loop.index }}</div>
                                <button type="button" class="btn-remove" onclick="removeAITask(this)">Remove</button>
                            </div>
                            <div class="form-group">
                                <label>Task Description</label>
                                <input type="text" name="ai_task_{{ loop.index0 }}_task" value="{{ task.task }}" placeholder="Describe the task">
                            </div>
                            <div class="two-column">
                                <div class="form-group">
                                    <label>Tool / Agent</label>
                                    <input type="text" name="ai_task_{{ loop.index0 }}_tool_agent" value="{{ task.tool_agent }}" placeholder="e.g., Cursor, ChatGPT">
                                </div>
                                <div class="form-group">
                                    <label>Time Saved (Est.)</label>
                                    <input type="text" name="ai_task_{{ loop.index0 }}_time_saved" value="{{ task.time_saved }}" placeholder="e.g., ~1-2 days">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Insight / Limitation</label>
                                <textarea name="ai_task_{{ loop.index0 }}_insight_failure" placeholder="What worked well or what didn't. Start a line with - for a bullet." rows="4">{{ task.insight_failure }}</textarea>
                                <small class="field-hint">Start a line with <code>-</code> for a bullet; other lines are normal text.</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="btn-add" onclick="addAITask()">+ Add AI Task</button>
                </div>
                
                <!-- SOP & Process Solidification -->
                <div class="section">
                    <div class="section-title">SOP & Process Solidification</div>
                    <div id="sop-list">
                        {% for item in defaults.sop_items %}
                        <div class="sop-item">
                            <div class="sop-item-header">
                                <span class="sop-item-title">SOP {{ loop.index }}</span>
                                <button type="button" class="btn-remove" onclick="removeSopItem(this)">Remove</button>
                            </div>
                            <div class="form-group">
                                <label>Item</label>
                                <input type="text" name="sop_item[]" value="{{ item.item }}" placeholder="Item">
                            </div>
                            <div class="form-group">
                                <label>Impact</label>
                                <textarea name="sop_impact[]" placeholder="Impact. Start a line with - for a bullet." rows="4">{{ item.impact }}</textarea>
                                <small class="field-hint">Start a line with <code>-</code> for a bullet; other lines are normal text.</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="btn-add" onclick="addSopItem()">+ Add Item</button>
                </div>
                
                <!-- Friction, Blockers & Ask -->
                <div class="section">
                    <div class="section-title">Friction, Blockers & Ask</div>
                    <div id="friction-list">
                        {% for item in defaults.friction_blockers_ask %}
                        <div class="friction-item">
                            <div class="friction-item-header">
                                <span class="friction-item-title">Friction {{ loop.index }}</span>
                                <button type="button" class="btn-remove" onclick="removeFrictionItem(this)">Remove</button>
                            </div>
                            <div class="form-group">
                                <label>Friction description:</label>
                                <input type="text" name="friction_friction[]" value="{{ item.friction }}" placeholder="Describe the friction or blocker">
                            </div>
                            <div class="form-group">
                                <label>Action/Mitigation:</label>
                                <input type="text" name="friction_action_mitigation[]" value="{{ item.action_mitigation }}" placeholder="What you did or will do">
                            </div>
                            <div class="form-group">
                                <label>Ask/Attention needed:</label>
                                <input type="text" name="friction_ask_attention[]" value="{{ item.ask_attention_needed }}" placeholder="What you need from others">
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="btn-add" onclick="addFrictionItem()">+ Add Item</button>
                </div>
                
                <!-- Next Week's Focus -->
                <div class="section">
                    <div class="section-title">Next Week's Focus</div>
                    <div id="next-week-list">
                        {% for item in defaults.next_week_focus %}
                        <div class="focus-item">
                            <div class="focus-item-header">
                                <span class="focus-item-title">Focus {{ loop.index }}</span>
                                <button type="button" class="btn-remove" onclick="removeFocusItem(this)">Remove</button>
                            </div>
                            <div class="form-group">
                                <input type="text" name="next_week_focus[]" value="{{ item }}" placeholder="Enter focus item">
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="btn-add" onclick="addNextWeekItem()">+ Add Item</button>
                </div>
                
                <!-- Submit -->
                <div class="submit-section">
                    <button type="submit" class="btn-submit" id="submit-btn">Generate Word Document</button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        let aiTaskCounter = {{ defaults.ai_tasks|length }};

        // Local draft storage (per-browser) to prevent shared YAML defaults in multi-user deployments.
        const DRAFT_STORAGE_KEY = 'weekly-report:draft:v1';
        let _draftSaveTimer = null;
        let _draftReady = false;

        function _safeJsonParse(text) {
            try { return JSON.parse(text); } catch (_) { return null; }
        }

        function _formatRelativeTime(tsMs) {
            if (!tsMs) return '';
            const diffMs = Date.now() - tsMs;
            if (!isFinite(diffMs) || diffMs < 0) return '';
            const sec = Math.floor(diffMs / 1000);
            if (sec < 60) return 'just now';
            const min = Math.floor(sec / 60);
            if (min < 60) return min + 'm ago';
            const hr = Math.floor(min / 60);
            if (hr < 48) return hr + 'h ago';
            const day = Math.floor(hr / 24);
            return day + 'd ago';
        }

        function _setDraftBanner(text) {
            const banner = document.getElementById('draft-banner');
            const bannerText = document.getElementById('draft-banner-text');
            if (!banner || !bannerText) return;
            if (!text) {
                banner.style.display = 'none';
                bannerText.textContent = '';
                return;
            }
            bannerText.textContent = text;
            banner.style.display = 'block';
        }

        function _scheduleDraftSave() {
            if (!_draftReady) return;
            if (_draftSaveTimer) clearTimeout(_draftSaveTimer);
            _draftSaveTimer = setTimeout(_saveDraftNow, 450);
        }

        function _getTextValue(el) {
            return (el && typeof el.value === 'string') ? el.value : '';
        }

        function _serializeDraftData() {
            const data = {
                name: _getTextValue(document.getElementById('name')).trim(),
                role: _getTextValue(document.getElementById('role')).trim(),
                name_for_file: _getTextValue(document.getElementById('name_for_file')).trim(),
                week: _getTextValue(document.getElementById('week-value')).trim(),
                weekly_objective: _getTextValue(document.getElementById('weekly_objective')),
                execution_output: [],
                ai_acceleration_tasks: [],
                sop_items: [],
                friction_blockers_ask: [],
                next_week_focus: []
            };

            document.querySelectorAll('#execution-output-list .execution-item').forEach((row) => {
                const summary = (row.querySelector('input[name="execution_summary[]"]') || {}).value || '';
                const content = (row.querySelector('textarea[name="execution_content[]"]') || {}).value || '';
                data.execution_output.push({ summary, content });
            });

            document.querySelectorAll('#ai-tasks-list .ai-task').forEach((row) => {
                const task = (row.querySelector('input[name^="ai_task_"][name$="_task"]') || {}).value || '';
                const tool_agent = (row.querySelector('input[name^="ai_task_"][name$="_tool_agent"]') || {}).value || '';
                const time_saved = (row.querySelector('input[name^="ai_task_"][name$="_time_saved"]') || {}).value || '';
                const insight_failure = (row.querySelector('textarea[name^="ai_task_"][name$="_insight_failure"]') || {}).value || '';
                data.ai_acceleration_tasks.push({ task, tool_agent, time_saved, insight_failure });
            });

            document.querySelectorAll('#sop-list .sop-item').forEach((row) => {
                const item = (row.querySelector('input[name="sop_item[]"]') || {}).value || '';
                const impact = (row.querySelector('textarea[name="sop_impact[]"]') || {}).value || '';
                data.sop_items.push({ item, impact });
            });

            document.querySelectorAll('#friction-list .friction-item').forEach((row) => {
                const friction = (row.querySelector('input[name="friction_friction[]"]') || {}).value || '';
                const action = (row.querySelector('input[name="friction_action_mitigation[]"]') || {}).value || '';
                const ask = (row.querySelector('input[name="friction_ask_attention[]"]') || {}).value || '';
                data.friction_blockers_ask.push({ friction, action_mitigation: action, ask_attention_needed: ask });
            });

            document.querySelectorAll('#next-week-list .focus-item').forEach((row) => {
                const text = (row.querySelector('input[name="next_week_focus[]"]') || {}).value || '';
                data.next_week_focus.push(text);
            });

            return data;
        }

        function _saveDraftNow() {
            try {
                const payload = { savedAt: Date.now(), data: _serializeDraftData() };
                localStorage.setItem(DRAFT_STORAGE_KEY, JSON.stringify(payload));
                const rel = _formatRelativeTime(payload.savedAt);
                _setDraftBanner(rel ? ('Draft saved locally (' + rel + ').') : 'Draft saved locally.');
            } catch (_) {
                // Ignore quota or storage failures.
            }
        }

        function _createEl(tag, className, text) {
            const el = document.createElement(tag);
            if (className) el.className = className;
            if (text !== undefined && text !== null) el.textContent = text;
            return el;
        }

        function _renderExecutionItems(items) {
            const container = document.getElementById('execution-output-list');
            if (!container) return;
            container.querySelectorAll('.execution-item').forEach(el => el.remove());
            const list = (items && items.length) ? items : [{ summary: '', content: '' }];
            executionItemCounter = 0;
            list.forEach((it) => {
                executionItemCounter++;
                const wrapper = _createEl('div', 'execution-item');
                const header = _createEl('div', 'execution-item-header');
                header.appendChild(_createEl('span', 'execution-item-title', 'Execution ' + executionItemCounter));
                const btn = _createEl('button', 'btn-remove', 'Remove');
                btn.type = 'button';
                btn.onclick = function () { removeExecutionItem(btn); };
                header.appendChild(btn);
                wrapper.appendChild(header);

                const g1 = _createEl('div', 'form-group');
                g1.appendChild(_createEl('label', null, 'Summary'));
                const summary = document.createElement('input');
                summary.type = 'text';
                summary.name = 'execution_summary[]';
                summary.placeholder = 'Bold statement / one-line summary';
                summary.value = (it && it.summary) ? it.summary : '';
                g1.appendChild(summary);
                wrapper.appendChild(g1);

                const g2 = _createEl('div', 'form-group');
                g2.appendChild(_createEl('label', null, 'Content'));
                const content = document.createElement('textarea');
                content.name = 'execution_content[]';
                content.rows = 6;
                content.placeholder = 'Type normally for text. Start a line with - for a bullet.';
                content.value = (it && it.content) ? it.content : '';
                g2.appendChild(content);
                const hint = _createEl('small', 'field-hint');
                hint.innerHTML = 'Start a line with <code>-</code> for a bullet; other lines are normal text.';
                g2.appendChild(hint);
                wrapper.appendChild(g2);

                container.appendChild(wrapper);
            });
        }

        function _renderAiTasks(tasks) {
            const container = document.getElementById('ai-tasks-list');
            if (!container) return;
            container.querySelectorAll('.ai-task').forEach(el => el.remove());
            const list = (tasks && tasks.length) ? tasks : [{ task: '', tool_agent: '', time_saved: '', insight_failure: '' }];
            aiTaskCounter = 0;
            list.forEach((t) => {
                const index = aiTaskCounter++;
                const titleNo = aiTaskCounter;

                const wrapper = _createEl('div', 'ai-task');
                wrapper.setAttribute('data-task-index', String(index));
                const header = _createEl('div', 'ai-task-header');
                header.appendChild(_createEl('div', 'ai-task-title', 'Task ' + titleNo));
                const btn = _createEl('button', 'btn-remove', 'Remove');
                btn.type = 'button';
                btn.onclick = function () { removeAITask(btn); };
                header.appendChild(btn);
                wrapper.appendChild(header);

                const g1 = _createEl('div', 'form-group');
                g1.appendChild(_createEl('label', null, 'Task Description'));
                const taskIn = document.createElement('input');
                taskIn.type = 'text';
                taskIn.name = `ai_task_${index}_task`;
                taskIn.placeholder = 'Describe the task';
                taskIn.value = (t && t.task) ? t.task : '';
                g1.appendChild(taskIn);
                wrapper.appendChild(g1);

                const grid = _createEl('div', 'two-column');
                const g2 = _createEl('div', 'form-group');
                g2.appendChild(_createEl('label', null, 'Tool / Agent'));
                const toolIn = document.createElement('input');
                toolIn.type = 'text';
                toolIn.name = `ai_task_${index}_tool_agent`;
                toolIn.placeholder = 'e.g., Cursor, ChatGPT';
                toolIn.value = (t && t.tool_agent) ? t.tool_agent : '';
                g2.appendChild(toolIn);
                grid.appendChild(g2);
                const g3 = _createEl('div', 'form-group');
                g3.appendChild(_createEl('label', null, 'Time Saved (Est.)'));
                const timeIn = document.createElement('input');
                timeIn.type = 'text';
                timeIn.name = `ai_task_${index}_time_saved`;
                timeIn.placeholder = 'e.g., ~1-2 days';
                timeIn.value = (t && t.time_saved) ? t.time_saved : '';
                g3.appendChild(timeIn);
                grid.appendChild(g3);
                wrapper.appendChild(grid);

                const g4 = _createEl('div', 'form-group');
                g4.appendChild(_createEl('label', null, 'Insight / Limitation'));
                const ins = document.createElement('textarea');
                ins.name = `ai_task_${index}_insight_failure`;
                ins.rows = 4;
                ins.placeholder = "What worked well or what didn't. Start a line with - for a bullet.";
                ins.value = (t && t.insight_failure) ? t.insight_failure : '';
                g4.appendChild(ins);
                const hint = _createEl('small', 'field-hint');
                hint.innerHTML = 'Start a line with <code>-</code> for a bullet; other lines are normal text.';
                g4.appendChild(hint);
                wrapper.appendChild(g4);

                container.appendChild(wrapper);
            });
        }

        function _renderFocusItems(items) {
            const container = document.getElementById('next-week-list');
            if (!container) return;
            container.querySelectorAll('.focus-item').forEach(el => el.remove());
            const list = (items && items.length) ? items : [''];
            focusItemCounter = 0;
            list.forEach((text) => {
                focusItemCounter++;
                const wrapper = _createEl('div', 'focus-item');
                const header = _createEl('div', 'focus-item-header');
                header.appendChild(_createEl('span', 'focus-item-title', 'Focus ' + focusItemCounter));
                const btn = _createEl('button', 'btn-remove', 'Remove');
                btn.type = 'button';
                btn.onclick = function () { removeFocusItem(btn); };
                header.appendChild(btn);
                wrapper.appendChild(header);
                const g = _createEl('div', 'form-group');
                const inp = document.createElement('input');
                inp.type = 'text';
                inp.name = 'next_week_focus[]';
                inp.placeholder = 'Enter focus item';
                inp.value = text || '';
                g.appendChild(inp);
                wrapper.appendChild(g);
                container.appendChild(wrapper);
            });
        }

        function _renderFrictionItems(items) {
            const container = document.getElementById('friction-list');
            if (!container) return;
            container.querySelectorAll('.friction-item').forEach(el => el.remove());
            const list = (items && items.length) ? items : [{ friction: '', action_mitigation: '', ask_attention_needed: '' }];
            frictionItemCounter = 0;
            list.forEach((f) => {
                frictionItemCounter++;
                const wrapper = _createEl('div', 'friction-item');
                const header = _createEl('div', 'friction-item-header');
                header.appendChild(_createEl('span', 'friction-item-title', 'Friction ' + frictionItemCounter));
                const btn = _createEl('button', 'btn-remove', 'Remove');
                btn.type = 'button';
                btn.onclick = function () { removeFrictionItem(btn); };
                header.appendChild(btn);
                wrapper.appendChild(header);

                const g1 = _createEl('div', 'form-group');
                g1.appendChild(_createEl('label', null, 'Friction description:'));
                const i1 = document.createElement('input');
                i1.type = 'text';
                i1.name = 'friction_friction[]';
                i1.placeholder = 'Describe the friction or blocker';
                i1.value = (f && f.friction) ? f.friction : '';
                g1.appendChild(i1);
                wrapper.appendChild(g1);

                const g2 = _createEl('div', 'form-group');
                g2.appendChild(_createEl('label', null, 'Action/Mitigation:'));
                const i2 = document.createElement('input');
                i2.type = 'text';
                i2.name = 'friction_action_mitigation[]';
                i2.placeholder = 'What you did or will do';
                i2.value = (f && f.action_mitigation) ? f.action_mitigation : '';
                g2.appendChild(i2);
                wrapper.appendChild(g2);

                const g3 = _createEl('div', 'form-group');
                g3.appendChild(_createEl('label', null, 'Ask/Attention needed:'));
                const i3 = document.createElement('input');
                i3.type = 'text';
                i3.name = 'friction_ask_attention[]';
                i3.placeholder = 'What you need from others';
                i3.value = (f && f.ask_attention_needed) ? f.ask_attention_needed : '';
                g3.appendChild(i3);
                wrapper.appendChild(g3);

                container.appendChild(wrapper);
            });
        }

        function _renderSopItems(items) {
            const container = document.getElementById('sop-list');
            if (!container) return;
            container.querySelectorAll('.sop-item').forEach(el => el.remove());
            const list = (items && items.length) ? items : [{ item: 'None', impact: 'N/A' }];
            sopItemCounter = 0;
            list.forEach((o) => {
                sopItemCounter++;
                const wrapper = _createEl('div', 'sop-item');
                const header = _createEl('div', 'sop-item-header');
                header.appendChild(_createEl('span', 'sop-item-title', 'SOP ' + sopItemCounter));
                const btn = _createEl('button', 'btn-remove', 'Remove');
                btn.type = 'button';
                btn.onclick = function () { removeSopItem(btn); };
                header.appendChild(btn);
                wrapper.appendChild(header);

                const g1 = _createEl('div', 'form-group');
                g1.appendChild(_createEl('label', null, 'Item'));
                const i1 = document.createElement('input');
                i1.type = 'text';
                i1.name = 'sop_item[]';
                i1.placeholder = 'Item';
                i1.value = (o && o.item !== undefined) ? (o.item || '') : '';
                g1.appendChild(i1);
                wrapper.appendChild(g1);

                const g2 = _createEl('div', 'form-group');
                g2.appendChild(_createEl('label', null, 'Impact'));
                const ta = document.createElement('textarea');
                ta.name = 'sop_impact[]';
                ta.rows = 4;
                ta.placeholder = 'Impact. Start a line with - for a bullet.';
                ta.value = (o && o.impact !== undefined) ? (o.impact || '') : '';
                g2.appendChild(ta);
                const hint = _createEl('small', 'field-hint');
                hint.innerHTML = 'Start a line with <code>-</code> for a bullet; other lines are normal text.';
                g2.appendChild(hint);
                wrapper.appendChild(g2);

                container.appendChild(wrapper);
            });
        }

        function _applyDraftData(d) {
            if (!d || typeof d !== 'object') return;
            if (d.name !== undefined) document.getElementById('name').value = d.name;
            if (d.role !== undefined) document.getElementById('role').value = d.role;
            if (d.name_for_file !== undefined) document.getElementById('name_for_file').value = d.name_for_file;
            if (d.weekly_objective !== undefined) document.getElementById('weekly_objective').value = d.weekly_objective;

            if (d.week) {
                const weekHidden = document.getElementById('week-value');
                if (weekHidden) weekHidden.value = d.week;
                if (window._setWeekFromWeekString) window._setWeekFromWeekString(d.week);
            }

            _renderExecutionItems(d.execution_output);
            _renderAiTasks(d.ai_acceleration_tasks);
            _renderSopItems(d.sop_items);
            _renderFrictionItems(d.friction_blockers_ask);
            _renderFocusItems(d.next_week_focus);
        }

        function _initDraftStorage() {
            const clearBtn = document.getElementById('draft-clear-btn');
            if (clearBtn) {
                clearBtn.addEventListener('click', function () {
                    try { localStorage.removeItem(DRAFT_STORAGE_KEY); } catch (_) {}
                    _setDraftBanner('Saved draft cleared. Reloading defaults...');
                    setTimeout(() => window.location.reload(), 150);
                });
            }

            const raw = (function () {
                try { return localStorage.getItem(DRAFT_STORAGE_KEY); } catch (_) { return null; }
            })();
            const payload = raw ? _safeJsonParse(raw) : null;
            if (payload && payload.data) {
                _applyDraftData(payload.data);
                const rel = _formatRelativeTime(payload.savedAt);
                _setDraftBanner(rel ? ('Restored local draft (saved ' + rel + ').') : 'Restored local draft.');
            }

            const form = document.getElementById('report-form');
            if (form) {
                form.addEventListener('input', _scheduleDraftSave);
                form.addEventListener('change', _scheduleDraftSave);
            }

            _draftReady = true;
        }
        
        (function initWeekCalendar() {
            const weekValue = document.getElementById('week-value');
            const weekRangeLabel = document.getElementById('week-range-label');
            
            function dateToYMD(d) {
                const y = d.getFullYear(), m = String(d.getMonth() + 1).padStart(2, '0'), day = String(d.getDate()).padStart(2, '0');
                return y + '-' + m + '-' + day;
            }
            
            function getMonday(d) {
                d = new Date(d);
                const daysToMonday = (d.getDay() + 6) % 7;
                d.setDate(d.getDate() - daysToMonday);
                return d;
            }
            
            function setWeekFromDate(dateInput) {
                const d = new Date(dateInput);
                const mon = getMonday(d);
                const fri = new Date(mon);
                fri.setDate(mon.getDate() + 4);
                const value = dateToYMD(mon) + ' ‚Üí ' + dateToYMD(fri);
                weekValue.value = value;
                const monFmt = mon.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const friFmt = fri.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                weekRangeLabel.textContent = monFmt + ' ‚Äì ' + friFmt;
                _scheduleDraftSave();
            }
            
            var defaultWeek = '{{ defaults.week }}';
            var defaultDate = null;
            if (defaultWeek && defaultWeek.indexOf(' ‚Üí ') !== -1) {
                var mondayStr = defaultWeek.split(' ‚Üí ')[0].trim();
                var parsed = new Date(mondayStr);
                defaultDate = isNaN(parsed.getTime()) ? new Date() : parsed;
                setWeekFromDate(defaultDate);
            } else {
                defaultDate = new Date();
                setWeekFromDate(defaultDate);
            }
            
            const picker = flatpickr('#week-calendar', {
                defaultDate: defaultDate,
                dateFormat: 'M j, Y',
                onChange: function(selectedDates) {
                    if (selectedDates.length) setWeekFromDate(selectedDates[0]);
                },
                altInput: false
            });

            window._weekPicker = picker;
            window._setWeekFromWeekString = function (weekStr) {
                const str = (weekStr || '').trim();
                if (!str || str.indexOf(' ‚Üí ') === -1) return;
                const parts = str.split(' ‚Üí ');
                if (parts.length !== 2) return;
                const mon = new Date(parts[0].trim());
                const fri = new Date(parts[1].trim());
                if (isNaN(mon.getTime()) || isNaN(fri.getTime())) return;
                weekValue.value = parts[0].trim() + ' ‚Üí ' + parts[1].trim();
                weekRangeLabel.textContent = mon.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ‚Äì ' + fri.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                try { picker.setDate(mon, false); } catch (_) {}
            };
            
            if (defaultDate && !weekRangeLabel.textContent) {
                var parts = defaultWeek.split(' ‚Üí ');
                if (parts.length === 2) {
                    var m = new Date(parts[0]), f = new Date(parts[1]);
                    weekRangeLabel.textContent = m.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ‚Äì ' + f.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                }
            }
        })();
        
        function addListItem(containerId, nameAttr, placeholder) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'list-item';
            div.innerHTML = `
                <input type="text" name="${nameAttr}" placeholder="${placeholder}">
                <button type="button" class="btn-remove" onclick="removeListItem(this)">Remove</button>
            `;
            container.appendChild(div);
        }
        
        function removeListItem(btn) {
            btn.closest('.list-item').remove();
            _scheduleDraftSave();
        }
        
        let executionItemCounter = {{ defaults.execution_output|length }};
        
        function addExecutionItem() {
            executionItemCounter++;
            const container = document.getElementById('execution-output-list');
            const div = document.createElement('div');
            div.className = 'execution-item';
            div.innerHTML = `
                <div class="execution-item-header">
                    <span class="execution-item-title">Execution ${executionItemCounter}</span>
                    <button type="button" class="btn-remove" onclick="removeExecutionItem(this)">Remove</button>
                </div>
                <div class="form-group">
                    <label>Summary</label>
                    <input type="text" name="execution_summary[]" placeholder="Bold statement / one-line summary">
                </div>
                <div class="form-group">
                    <label>Content</label>
                    <textarea name="execution_content[]" placeholder="Type normally for text. Start a line with - for a bullet." rows="6"></textarea>
                    <small class="field-hint">Start a line with <code>-</code> for a bullet; other lines are normal text.</small>
                </div>
            `;
            container.appendChild(div);
            _scheduleDraftSave();
        }
        
        function removeExecutionItem(btn) {
            btn.closest('.execution-item').remove();
            _scheduleDraftSave();
        }
        
        let sopItemCounter = {{ defaults.sop_items|length }};
        
        function addSopItem() {
            sopItemCounter++;
            const container = document.getElementById('sop-list');
            const div = document.createElement('div');
            div.className = 'sop-item';
            div.innerHTML = `
                <div class="sop-item-header">
                    <span class="sop-item-title">SOP ${sopItemCounter}</span>
                    <button type="button" class="btn-remove" onclick="removeSopItem(this)">Remove</button>
                </div>
                <div class="form-group">
                    <label>Item</label>
                    <input type="text" name="sop_item[]" placeholder="Item">
                </div>
                <div class="form-group">
                    <label>Impact</label>
                    <textarea name="sop_impact[]" placeholder="Impact. Start a line with - for a bullet." rows="4"></textarea>
                    <small class="field-hint">Start a line with <code>-</code> for a bullet; other lines are normal text.</small>
                </div>
            `;
            container.appendChild(div);
            _scheduleDraftSave();
        }
        
        function removeSopItem(btn) {
            btn.closest('.sop-item').remove();
            _scheduleDraftSave();
        }
        
        let frictionItemCounter = {{ defaults.friction_blockers_ask|length }};
        
        function addFrictionItem() {
            frictionItemCounter++;
            const container = document.getElementById('friction-list');
            const div = document.createElement('div');
            div.className = 'friction-item';
            div.innerHTML = `
                <div class="friction-item-header">
                    <span class="friction-item-title">Friction ${frictionItemCounter}</span>
                    <button type="button" class="btn-remove" onclick="removeFrictionItem(this)">Remove</button>
                </div>
                <div class="form-group">
                    <label>Friction description:</label>
                    <input type="text" name="friction_friction[]" placeholder="Describe the friction or blocker">
                </div>
                <div class="form-group">
                    <label>Action/Mitigation:</label>
                    <input type="text" name="friction_action_mitigation[]" placeholder="What you did or will do">
                </div>
                <div class="form-group">
                    <label>Ask/Attention needed:</label>
                    <input type="text" name="friction_ask_attention[]" placeholder="What you need from others">
                </div>
            `;
            container.appendChild(div);
            _scheduleDraftSave();
        }
        
        function removeFrictionItem(btn) {
            btn.closest('.friction-item').remove();
            _scheduleDraftSave();
        }
        
        let focusItemCounter = {{ defaults.next_week_focus|length }};
        
        function addNextWeekItem() {
            focusItemCounter++;
            const container = document.getElementById('next-week-list');
            const div = document.createElement('div');
            div.className = 'focus-item';
            div.innerHTML = `
                <div class="focus-item-header">
                    <span class="focus-item-title">Focus ${focusItemCounter}</span>
                    <button type="button" class="btn-remove" onclick="removeFocusItem(this)">Remove</button>
                </div>
                <div class="form-group">
                    <input type="text" name="next_week_focus[]" placeholder="Enter focus item">
                </div>
            `;
            container.appendChild(div);
            _scheduleDraftSave();
        }
        
        function removeFocusItem(btn) {
            btn.closest('.focus-item').remove();
            _scheduleDraftSave();
        }

        function normalizeInlineBullets(text) {
            if (!text) return '';
            return String(text)
                .replace(/\r\n/g, '\n')
                .replace(/([.!?:])\s+-\s+/g, '$1\n- ');
        }
        
        let _aiSuggestion = null;
        let _aiViewMode = 'formatted'; // 'formatted' or 'json'
        
        function renderAIPreviewFormatted(data) {
            let html = '';
            
            // Weekly Objective
            if (data.weekly_objective) {
                html += '<div class="ai-preview-section">';
                html += '<div class="ai-preview-title">Weekly Objective</div>';
                html += '<div class="ai-preview-content">' + escapeHtml(data.weekly_objective) + '</div>';
                html += '</div>';
            }
            
            // Execution & Output
            if (data.execution_output && data.execution_output.length > 0) {
                html += '<div class="ai-preview-section">';
                html += '<div class="ai-preview-title">Execution & Output (' + data.execution_output.length + ' items)</div>';
                data.execution_output.forEach(function(item, idx) {
                    html += '<div class="ai-preview-item">';
                    if (item.summary) {
                        html += '<div class="ai-preview-item-title">' + (idx + 1) + '. ' + escapeHtml(item.summary) + '</div>';
                    }
                    if (item.content) {
                        html += '<div class="ai-preview-content">' + escapeHtml(item.content) + '</div>';
                    }
                    html += '</div>';
                });
                html += '</div>';
            }
            
            // AI Acceleration
            if (data.ai_acceleration_tasks && data.ai_acceleration_tasks.length > 0) {
                html += '<div class="ai-preview-section">';
                html += '<div class="ai-preview-title">AI Acceleration (' + data.ai_acceleration_tasks.length + ' tasks)</div>';
                data.ai_acceleration_tasks.forEach(function(task, idx) {
                    html += '<div class="ai-preview-item">';
                    html += '<div class="ai-preview-item-title">' + (idx + 1) + '. ' + escapeHtml(task.task || 'Task') + '</div>';
                    if (task.tool_agent || task.time_saved) {
                        html += '<div style="font-size: 12px; color: #666; margin-bottom: 6px;">';
                        if (task.tool_agent) html += '<strong>Tool:</strong> ' + escapeHtml(task.tool_agent) + ' ';
                        if (task.time_saved) html += '<strong>Time saved:</strong> ' + escapeHtml(task.time_saved);
                        html += '</div>';
                    }
                    if (task.insight_failure) {
                        html += '<div class="ai-preview-content" style="margin-top: 6px;">' + escapeHtml(task.insight_failure) + '</div>';
                    }
                    html += '</div>';
                });
                html += '</div>';
            }
            
            // Friction, Blockers & Ask
            if (data.friction_blockers_ask && data.friction_blockers_ask.length > 0 && 
                data.friction_blockers_ask.some(f => f.friction || f.action_mitigation || f.ask_attention_needed)) {
                html += '<div class="ai-preview-section">';
                html += '<div class="ai-preview-title">Friction, Blockers & Ask</div>';
                data.friction_blockers_ask.forEach(function(item, idx) {
                    if (item.friction || item.action_mitigation || item.ask_attention_needed) {
                        html += '<div class="ai-preview-item">';
                        if (item.friction) {
                            html += '<div style="margin-bottom: 6px;"><strong>Friction:</strong> ' + escapeHtml(item.friction) + '</div>';
                        }
                        if (item.action_mitigation) {
                            html += '<div style="margin-bottom: 6px;"><strong>Action:</strong> ' + escapeHtml(item.action_mitigation) + '</div>';
                        }
                        if (item.ask_attention_needed) {
                            html += '<div><strong>Ask:</strong> ' + escapeHtml(item.ask_attention_needed) + '</div>';
                        }
                        html += '</div>';
                    }
                });
                html += '</div>';
            }
            
            // SOP & Process
            if (data.sop_items && data.sop_items.length > 0 && 
                data.sop_items.some(s => (s.item && s.item !== 'None') || (s.impact && s.impact !== 'N/A'))) {
                html += '<div class="ai-preview-section">';
                html += '<div class="ai-preview-title">SOP & Process Solidification</div>';
                data.sop_items.forEach(function(item, idx) {
                    if ((item.item && item.item !== 'None') || (item.impact && item.impact !== 'N/A')) {
                        html += '<div class="ai-preview-item">';
                        if (item.item) {
                            html += '<div class="ai-preview-item-title">' + escapeHtml(item.item) + '</div>';
                        }
                        if (item.impact) {
                            html += '<div class="ai-preview-content">' + escapeHtml(item.impact) + '</div>';
                        }
                        html += '</div>';
                    }
                });
                html += '</div>';
            }
            
            // Next Week Focus
            if (data.next_week_focus && data.next_week_focus.length > 0) {
                html += '<div class="ai-preview-section">';
                html += '<div class="ai-preview-title">Next Week\'s Focus (' + data.next_week_focus.length + ' items)</div>';
                html += '<div class="ai-preview-content">';
                data.next_week_focus.forEach(function(focus, idx) {
                    if (focus) {
                        html += (idx + 1) + '. ' + escapeHtml(focus) + '\n';
                    }
                });
                html += '</div>';
                html += '</div>';
            }
            
            return html || '<div style="color: #999; font-style: italic;">No content generated</div>';
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }
        
        function renderAIPreview(data, mode) {
            const resultDiv = document.getElementById('ai-suggest-result');
            if (mode === 'json') {
                resultDiv.innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
            } else {
                resultDiv.innerHTML = renderAIPreviewFormatted(data);
            }
        }
        
        document.getElementById('ai-suggest-btn').addEventListener('click', async function() {
            const notes = document.getElementById('ai-notes').value.trim();
            const style = document.getElementById('ai-style-select').value || 'quick';
            const btn = this;
            const status = document.getElementById('ai-suggest-status');
            const applyStatus = document.getElementById('ai-apply-status');
            const resultContainer = document.getElementById('ai-suggest-result-container');
            const errDiv = document.getElementById('ai-suggest-error');
            const applyRow = document.getElementById('ai-apply-row');
            if (!notes) { errDiv.textContent = 'Enter some notes first.'; errDiv.style.display = 'block'; return; }
            errDiv.style.display = 'none';
            btn.disabled = true;
            status.textContent = 'Calling AI...';
            if (applyStatus) applyStatus.textContent = '';
            try {
                const res = await fetch('/api/suggest', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ notes, style }) });
                const data = await res.json();
                if (!res.ok) { errDiv.textContent = data.error || 'Request failed'; errDiv.style.display = 'block'; resultContainer.style.display = 'none'; applyRow.style.display = 'none'; return; }
                _aiSuggestion = data;
                _aiViewMode = 'formatted';
                renderAIPreview(data, _aiViewMode);
                document.getElementById('ai-view-formatted').classList.add('active');
                document.getElementById('ai-view-json').classList.remove('active');
                resultContainer.style.display = 'block';
                applyRow.style.display = 'block';
                status.textContent = 'Done. Review below and click Apply to form.';
            } catch (e) {
                errDiv.textContent = e.message || 'Network error';
                errDiv.style.display = 'block';
            } finally {
                btn.disabled = false;
            }
        });
        
        // Toggle between formatted and JSON view
        document.getElementById('ai-view-formatted').addEventListener('click', function() {
            if (_aiSuggestion) {
                _aiViewMode = 'formatted';
                renderAIPreview(_aiSuggestion, _aiViewMode);
                this.classList.add('active');
                document.getElementById('ai-view-json').classList.remove('active');
            }
        });
        
        document.getElementById('ai-view-json').addEventListener('click', function() {
            if (_aiSuggestion) {
                _aiViewMode = 'json';
                renderAIPreview(_aiSuggestion, _aiViewMode);
                this.classList.add('active');
                document.getElementById('ai-view-formatted').classList.remove('active');
            }
        });
        
        document.getElementById('ai-apply-btn').addEventListener('click', function() {
            const s = _aiSuggestion;
            if (!s) return;
            if (s.weekly_objective) document.getElementById('weekly_objective').value = s.weekly_objective;
            const aiList = document.getElementById('ai-tasks-list');
            const execList = document.getElementById('execution-output-list');
            if (s.execution_output && Array.isArray(s.execution_output) && s.execution_output.length) {
                execList.querySelectorAll('.execution-item').forEach(el => el.remove());
                executionItemCounter = 0;
                s.execution_output.forEach(function(item) {
                    executionItemCounter++;
                    const div = document.createElement('div');
                    div.className = 'execution-item';
                    div.innerHTML = `
                        <div class="execution-item-header">
                            <span class="execution-item-title">Execution ${executionItemCounter}</span>
                            <button type="button" class="btn-remove" onclick="removeExecutionItem(this)">Remove</button>
                        </div>
                        <div class="form-group">
                            <label>Summary</label>
                            <input type="text" name="execution_summary[]" value="${(item.summary || '').replace(/"/g, '&quot;')}" placeholder="Bold statement / one-line summary">
                        </div>
                        <div class="form-group">
                            <label>Content</label>
                            <textarea name="execution_content[]" placeholder="Start a line with - for a bullet." rows="6">${normalizeInlineBullets(item.content || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
                            <small class="field-hint">Start a line with <code>-</code> for a bullet; other lines are normal text.</small>
                        </div>
                    `;
                    execList.appendChild(div);
                });
            }

            if (s.ai_acceleration_tasks && Array.isArray(s.ai_acceleration_tasks) && s.ai_acceleration_tasks.length) {
                aiList.querySelectorAll('.ai-task').forEach(el => el.remove());
                aiTaskCounter = 0;
                s.ai_acceleration_tasks.forEach(function(t) {
                    const index = aiTaskCounter++;
                    const titleNo = aiTaskCounter;
                    const div = document.createElement('div');
                    div.className = 'ai-task';
                    div.setAttribute('data-task-index', index);
                    div.innerHTML = `
                        <div class="ai-task-header">
                            <div class="ai-task-title">Task ${titleNo}</div>
                            <button type="button" class="btn-remove" onclick="removeAITask(this)">Remove</button>
                        </div>
                        <div class="form-group">
                            <label>Task Description</label>
                            <input type="text" name="ai_task_${index}_task" value="${(t.task || '').replace(/"/g, '&quot;')}" placeholder="Describe the task">
                        </div>
                        <div class="two-column">
                            <div class="form-group">
                                <label>Tool / Agent</label>
                                <input type="text" name="ai_task_${index}_tool_agent" value="${(t.tool_agent || '').replace(/"/g, '&quot;')}" placeholder="e.g., Cursor, ChatGPT">
                            </div>
                            <div class="form-group">
                                <label>Time Saved (Est.)</label>
                                <input type="text" name="ai_task_${index}_time_saved" value="${(t.time_saved || '').replace(/"/g, '&quot;')}" placeholder="e.g., ~1-2 days">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Insight / Limitation</label>
                            <textarea name="ai_task_${index}_insight_failure" placeholder="What worked well or what didn't. Start a line with - for a bullet." rows="4">${normalizeInlineBullets(t.insight_failure || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
                            <small class="field-hint">Start a line with <code>-</code> for a bullet; other lines are normal text.</small>
                        </div>
                    `;
                    aiList.appendChild(div);
                });
            }
            const focusList = document.getElementById('next-week-list');
            if (s.next_week_focus && Array.isArray(s.next_week_focus) && s.next_week_focus.length) {
                focusList.querySelectorAll('.focus-item').forEach(el => el.remove());
                focusItemCounter = 0;
                s.next_week_focus.forEach(function(text) {
                    focusItemCounter++;
                    const div = document.createElement('div');
                    div.className = 'focus-item';
                    div.innerHTML = `
                        <div class="focus-item-header">
                            <span class="focus-item-title">Focus ${focusItemCounter}</span>
                            <button type="button" class="btn-remove" onclick="removeFocusItem(this)">Remove</button>
                        </div>
                        <div class="form-group">
                            <input type="text" name="next_week_focus[]" value="${(text || '').replace(/"/g, '&quot;')}" placeholder="Enter focus item">
                        </div>
                    `;
                    focusList.appendChild(div);
                });
            }
            const frictionList = document.getElementById('friction-list');
            if (s.friction_blockers_ask && Array.isArray(s.friction_blockers_ask) && s.friction_blockers_ask.length) {
                frictionList.querySelectorAll('.friction-item').forEach(el => el.remove());
                frictionItemCounter = 0;
                s.friction_blockers_ask.forEach(function(f) {
                    frictionItemCounter++;
                    const div = document.createElement('div');
                    div.className = 'friction-item';
                    div.innerHTML = `
                        <div class="friction-item-header">
                            <span class="friction-item-title">Friction ${frictionItemCounter}</span>
                            <button type="button" class="btn-remove" onclick="removeFrictionItem(this)">Remove</button>
                        </div>
                        <div class="form-group">
                            <label>Friction description:</label>
                            <input type="text" name="friction_friction[]" value="${(f.friction || '').replace(/"/g, '&quot;')}" placeholder="Describe the friction or blocker">
                        </div>
                        <div class="form-group">
                            <label>Action/Mitigation:</label>
                            <input type="text" name="friction_action_mitigation[]" value="${(f.action_mitigation || '').replace(/"/g, '&quot;')}" placeholder="What you did or will do">
                        </div>
                        <div class="form-group">
                            <label>Ask/Attention needed:</label>
                            <input type="text" name="friction_ask_attention[]" value="${(f.ask_attention_needed || '').replace(/"/g, '&quot;')}" placeholder="What you need from others">
                        </div>
                    `;
                    frictionList.appendChild(div);
                });
            }
            const sopList = document.getElementById('sop-list');
            if (s.sop_items && Array.isArray(s.sop_items) && s.sop_items.length) {
                sopList.querySelectorAll('.sop-item').forEach(el => el.remove());
                sopItemCounter = 0;
                s.sop_items.forEach(function(o) {
                    sopItemCounter++;
                    const div = document.createElement('div');
                    div.className = 'sop-item';
                    div.innerHTML = `
                        <div class="sop-item-header">
                            <span class="sop-item-title">SOP ${sopItemCounter}</span>
                            <button type="button" class="btn-remove" onclick="removeSopItem(this)">Remove</button>
                        </div>
                        <div class="form-group">
                            <label>Item</label>
                            <input type="text" name="sop_item[]" value="${(o.item || '').replace(/"/g, '&quot;')}" placeholder="Item">
                        </div>
                        <div class="form-group">
                            <label>Impact</label>
                            <textarea name="sop_impact[]" placeholder="Impact. Start a line with - for a bullet." rows="4">${normalizeInlineBullets(o.impact || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
                            <small class="field-hint">Start a line with <code>-</code> for a bullet; other lines are normal text.</small>
                        </div>
                    `;
                    sopList.appendChild(div);
                });
            }
            const status = document.getElementById('ai-suggest-status');
            if (status) status.textContent = '';
            const applyStatus = document.getElementById('ai-apply-status');
            if (applyStatus) {
                applyStatus.textContent = 'Filled.';
                setTimeout(() => { applyStatus.textContent = ''; }, 2000);
            }
            _scheduleDraftSave();
        });
        
        function addAITask() {
            const container = document.getElementById('ai-tasks-list');
            const index = aiTaskCounter++;
            const div = document.createElement('div');
            div.className = 'ai-task';
            div.setAttribute('data-task-index', index);
            div.innerHTML = `
                <div class="ai-task-header">
                    <div class="ai-task-title">Task ${aiTaskCounter}</div>
                    <button type="button" class="btn-remove" onclick="removeAITask(this)">Remove</button>
                </div>
                <div class="form-group">
                    <label>Task Description</label>
                    <input type="text" name="ai_task_${index}_task" placeholder="Describe the task">
                </div>
                <div class="two-column">
                    <div class="form-group">
                        <label>Tool / Agent</label>
                        <input type="text" name="ai_task_${index}_tool_agent" placeholder="e.g., Cursor, ChatGPT">
                    </div>
                    <div class="form-group">
                        <label>Time Saved (Est.)</label>
                        <input type="text" name="ai_task_${index}_time_saved" placeholder="e.g., ~1-2 days">
                    </div>
                </div>
                <div class="form-group">
                    <label>Insight / Limitation</label>
                    <textarea name="ai_task_${index}_insight_failure" placeholder="What worked well or what didn't. Start a line with - for a bullet." rows="4"></textarea>
                    <small class="field-hint">Start a line with <code>-</code> for a bullet; other lines are normal text.</small>
                </div>
            `;
            container.appendChild(div);
            _scheduleDraftSave();
        }
        
        function removeAITask(btn) {
            btn.closest('.ai-task').remove();
            _scheduleDraftSave();
        }
        
        document.getElementById('report-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submit-btn');
            const loading = document.getElementById('loading');
            const errorMsg = document.getElementById('error-message');
            const successMsg = document.getElementById('success-message');
            
            // Hide previous messages
            errorMsg.style.display = 'none';
            successMsg.style.display = 'none';
            
            // Show loading
            loading.style.display = 'block';
            submitBtn.disabled = true;
            
            try {
                const formData = new FormData(this);
                const response = await fetch('/generate', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    // Use filename from Content-Disposition when present
                    let downloadName = `Weekly_Report_${new Date().toISOString().split('T')[0]}.docx`;
                    const cd = response.headers.get('Content-Disposition');
                    if (cd) {
                        // filename*=UTF-8''encoded (RFC 5987) or filename="full name with spaces"
                        const mStar = cd.match(/filename\*=UTF-8''([^;\s]+)/i);
                        const mQuoted = cd.match(/filename="([^"]*)"/);
                        if (mStar && mStar[1]) {
                            try { downloadName = decodeURIComponent(mStar[1]); } catch (_) {}
                        } else if (mQuoted && mQuoted[1]) {
                            downloadName = mQuoted[1];
                        }
                    }
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = downloadName;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    successMsg.textContent = 'Report generated successfully! Download started.';
                    successMsg.style.display = 'block';
                } else {
                    const error = await response.json();
                    errorMsg.textContent = error.error || 'An error occurred';
                    errorMsg.style.display = 'block';
                }
            } catch (error) {
                errorMsg.textContent = 'Network error: ' + error.message;
                errorMsg.style.display = 'block';
            } finally {
                loading.style.display = 'none';
                submitBtn.disabled = false;
            }
        });

        // Copy AI example template to clipboard
        (function () {
            const btn = document.getElementById('ai-example-copy');
            const pre = document.getElementById('ai-example-text');
            const status = document.getElementById('ai-example-status');
            if (!btn || !pre) return;
            btn.addEventListener('click', async function () {
                const text = (pre.textContent || '').trim();
                try {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        await navigator.clipboard.writeText(text);
                    } else {
                        const ta = document.createElement('textarea');
                        ta.value = text;
                        document.body.appendChild(ta);
                        ta.select();
                        document.execCommand('copy');
                        document.body.removeChild(ta);
                    }
                    if (status) status.textContent = 'Copied.';
                    setTimeout(() => { if (status) status.textContent = ''; }, 1500);
                } catch (e) {
                    if (status) status.textContent = 'Copy failed ‚Äî select and copy manually.';
                }
            });
        })();

        // Restore + autosave draft (localStorage) after all handlers exist.
        _initDraftStorage();
    </script>
</body>
</html>
