name: AI Issue -> PR (aider)

"on":
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  ai_pr:
    if: >-
      github.event.issue.pull_request == null &&
      startsWith(github.event.comment.body, '/ai-pr') &&
      (github.event.comment.author_association == 'OWNER' ||
       github.event.comment.author_association == 'MEMBER' ||
       github.event.comment.author_association == 'COLLABORATOR')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: develop

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install aider
        run: |
          python -m pip install --upgrade pip
          python -m pip install aider-chat

      - name: Build prompt
        id: prompt
        shell: bash
        run: |
          set -euo pipefail

          ISSUE_NUMBER='${{ github.event.issue.number }}'
          ISSUE_TITLE='${{ github.event.issue.title }}'
          ISSUE_BODY='${{ github.event.issue.body }}'
          COMMENT_BODY='${{ github.event.comment.body }}'

          # Remove the trigger line. Allow extra instructions after /ai-pr.
          EXTRA_INSTRUCTIONS="$(printf '%s' "$COMMENT_BODY" | sed '1s#^/ai-pr##' | sed 's/^[[:space:]]*//' )"

          RULES="$(cat AGENTS.md)"

          cat > /tmp/aider_prompt.txt <<EOF
          You are an AI coding agent operating inside a GitHub Actions workflow.

          Follow these repo rules:
          $RULES

          Task: address GitHub issue #$ISSUE_NUMBER.

          Issue title:
          $ISSUE_TITLE

          Issue body:
          $ISSUE_BODY

          Extra instructions (from the /ai-pr comment):
          $EXTRA_INSTRUCTIONS

          CRITICAL - File Selection:
          - If the issue mentions "Web UI" or "web form" or "browser", the fix is almost certainly in app.py or templates/index.html
          - If the issue mentions "CLI" or "command line" or "fill_weekly_report.py", the fix is in fill_weekly_report.py
          - If the issue mentions "Word document" generation logic, check generate_weekly_report_from_template.py
          - DO NOT modify files unrelated to the issue
          - If unsure which file to modify, analyze the issue carefully and ask yourself: "Where does this functionality live?"

          Requirements:
          - Make the smallest correct change
          - Do not modify secrets or .env files
          - Do not change GitHub Actions workflows unless the issue explicitly requests it
          - After code changes, ensure: python -m py_compile app.py generate_weekly_report_from_template.py fill_weekly_report.py
          - If you cannot determine the correct fix, explain why instead of making random changes
          EOF

          echo "prompt_file=/tmp/aider_prompt.txt" >> "$GITHUB_OUTPUT"

      - name: Run aider
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -euo pipefail

          # Store initial git state
          BEFORE_SHA=$(git rev-parse HEAD)
          echo "BEFORE_SHA=$BEFORE_SHA" >> "$GITHUB_ENV"

          # Provide a focused starting set of files; aider may still modify others if needed.
          aider \
            --model gpt-4o-mini \
            --yes \
            --message-file "${{ steps.prompt.outputs.prompt_file }}" \
            app.py \
            templates/index.html \
            generate_weekly_report_from_template.py \
            fill_weekly_report.py \
            README.md \
            requirements.txt

      - name: Verify changes were made
        id: verify_changes
        run: |
          set -euo pipefail
          
          AFTER_SHA=$(git rev-parse HEAD)
          
          if [ "$BEFORE_SHA" = "$AFTER_SHA" ]; then
            echo "‚ùå ERROR: Aider did not make any commits!"
            echo "This usually means:"
            echo "  - Aider couldn't determine what to change"
            echo "  - Aider hit an error or reflection limit"
            echo "  - The issue description wasn't clear enough"
            echo ""
            echo "Check the aider logs above for details."
            exit 1
          fi
          
          # Check if there are actual file changes
          CHANGED_FILES=$(git diff --name-only "$BEFORE_SHA" "$AFTER_SHA")
          if [ -z "$CHANGED_FILES" ]; then
            echo "‚ùå ERROR: Commit exists but no files were changed!"
            exit 1
          fi
          
          echo "‚úÖ Changes detected in:"
          echo "$CHANGED_FILES"
          
          # Save for later steps
          echo "changed_files<<EOF" >> "$GITHUB_OUTPUT"
          echo "$CHANGED_FILES" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Basic compile check
        run: python -m py_compile app.py generate_weekly_report_from_template.py fill_weekly_report.py

      - name: Extract commit summary
        id: commit_summary
        run: |
          # Get the last commit message (aider's auto-generated message)
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "message<<EOF" >> "$GITHUB_OUTPUT"
          echo "$COMMIT_MSG" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Create pull request
        id: create_pr
        uses: peter-evans/create-pull-request@v7
        with:
          base: develop
          branch: ai/issue-${{ github.event.issue.number }}
          delete-branch: true
          title: "AI: #${{ github.event.issue.number }} ${{ github.event.issue.title }}"
          body: |
            Fixes #${{ github.event.issue.number }}.
            
            ## Changes
            
            ${{ steps.commit_summary.outputs.message }}
            
            ## Files Modified
            
            ```
            ${{ steps.verify_changes.outputs.changed_files }}
            ```
            
            ---
            
            ü§ñ Generated by aider | Triggered by: @${{ github.actor }}
          commit-message: "AI: address issue #${{ github.event.issue.number }}"
          reviewers: joeywcl
      
      - name: Verify PR was created
        if: steps.create_pr.outputs.pull-request-number == ''
        run: |
          echo "‚ùå ERROR: No pull request was created!"
          echo "This can happen if:"
          echo "  - No files were actually changed"
          echo "  - Changes were identical to existing branch"
          exit 1
      
      - name: Comment on issue with PR link
        if: steps.create_pr.outputs.pull-request-number != ''
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚úÖ Pull request created: #${{ steps.create_pr.outputs.pull-request-number }}\n\nPlease review the changes and merge if they look good.`
            })
